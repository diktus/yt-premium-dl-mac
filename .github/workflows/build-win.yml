name: Build Windows Application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install customtkinter Pillow requests pyinstaller

    - name: Download Binaries (Windows)
      shell: pwsh
      run: |
        # Buat folder bin
        New-Item -ItemType Directory -Force -Path bin
        
        Write-Host "⬇️ Downloading yt-dlp.exe..."
        Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "bin\yt-dlp.exe"
        
        Write-Host "⬇️ Downloading Node.js (Latest)..."
        Invoke-WebRequest -Uri "https://nodejs.org/dist/latest-v20.x/win-x64/node.exe" -OutFile "bin\node.exe"
        
        Write-Host "⬇️ Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "."
        
        # Cari folder hasil ekstrak (karena namanya berubah-ubah sesuai versi)
        $ffmpegDir = Get-ChildItem -Directory -Filter "ffmpeg-*-essentials_build"
        Move-Item "$($ffmpegDir.FullName)\bin\ffmpeg.exe" "bin\ffmpeg.exe"
        Move-Item "$($ffmpegDir.FullName)\bin\ffprobe.exe" "bin\ffprobe.exe"
        
        # Bersih-bersih file sampah
        Remove-Item "ffmpeg.zip"
        Remove-Item $ffmpegDir -Recurse -Force

    - name: Build .exe with PyInstaller
      shell: pwsh
      run: |
        # Build Single File Executable (--onefile)
        # --windowed: Sembunyikan console saat dijalankan
        # --add-data: Masukkan folder bin ke dalam exe (format windows separator ;)
        pyinstaller --noconfirm --onefile --windowed --name "YTProDownloader" --add-data "bin;bin" app_gui_win.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: YT-Download-Windows
        path: dist/YTProDownloader.exe
