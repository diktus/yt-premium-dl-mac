name: Build Windows Application

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # Trigger build & release saat push tag (contoh: v1.3.2)
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write # Wajib: Memberi izin bot untuk membuat Release

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Download Binaries (Windows)
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path bin
        
        Write-Host "⬇️ Downloading yt-dlp.exe..."
        Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "bin\yt-dlp.exe"
        
        Write-Host "⬇️ Downloading Node.js (Latest)..."
        Invoke-WebRequest -Uri "https://nodejs.org/dist/latest-v20.x/win-x64/node.exe" -OutFile "bin\node.exe"
        
        Write-Host "⬇️ Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "."
        
        $ffmpegDir = Get-ChildItem -Directory -Filter "ffmpeg-*-essentials_build"
        Move-Item "$($ffmpegDir.FullName)\bin\ffmpeg.exe" "bin\ffmpeg.exe"
        Move-Item "$($ffmpegDir.FullName)\bin\ffprobe.exe" "bin\ffprobe.exe"
        
        Remove-Item "ffmpeg.zip"
        Remove-Item $ffmpegDir -Recurse -Force

    - name: Build .exe with PyInstaller
      shell: pwsh
      run: |
        # Build Single File Executable
        pyinstaller --noconfirm --onefile --windowed --name "YTProDownloader" --add-data "bin;bin" app_gui_win.py

    # 1. Upload sebagai Artifact (Selalu dijalankan)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: YT-Download-Windows
        path: dist/YTProDownloader.exe

    # 2. Upload sebagai Release (Hanya jika ada Tag v*)
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/YTProDownloader.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
